!function(r){"use strict";Modernizr.addTest("csstransformspreserve3d",function(){var s,i=Modernizr.prefixed("transformStyle"),t="preserve-3d";return!!i&&(i=i.replace(/([A-Z])/g,function(t,e){return"-"+e.toLowerCase()}).replace(/^ms-/,"-ms-"),Modernizr.testStyles("#modernizr{"+i+":"+t+";}",function(t,e){s=r.getComputedStyle?getComputedStyle(t,null).getPropertyValue(i):""}),s===t)});var z=Modernizr.csstransitions,i=Modernizr.csstransformspreserve3d,x={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd",msTransition:"MSTransitionEnd",transition:"transitionend"}[Modernizr.prefixed("transition")];function s(t,e){for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);return t}function k(t){for(var e=[],s=t.length,i=t[0].length,r=0;r<s;r++)e=e.concat(t[r]);e=function(t){var e,s,i=t.length;for(;i;)s=Math.floor(Math.random()*i--),e=t[i],t[i]=t[s],t[s]=e;return t}(e);for(var n=[],a=0,o=0;o<s;o++){for(var h=[],c=0;c<i;c++)h.push(e[a]),a++;n.push(h)}return n}function t(t,e){this.el=t,this.inner=this.el.querySelector("div"),this.allItems=[].slice.call(this.inner.children),this.allItemsCount=this.allItems.length,this.allItemsCount&&(this.items=[].slice.call(this.inner.querySelectorAll("figure:not([data-dummy])")),this.itemsCount=this.items.length,this.current=0,this.options=s({},this.options),s(this.options,e),this._init())}t.prototype.options={},t.prototype._init=function(){this.currentItem=this.items[this.current],this._addNavigation(),this._getSizes(),this._initEvents()},t.prototype._addNavigation=function(){this.nav=document.createElement("nav");for(var t="",e=0;e<this.itemsCount;++e)t+="<span></span>";this.nav.innerHTML=t,this.el.appendChild(this.nav),this.navDots=[].slice.call(this.nav.children)},t.prototype._initEvents=function(){var s=this,e=classie.hasClass(this.el,"photostack-start"),i=function(){var t=function(){z&&classie.addClass(s.el,"photostack-transition")};e?(this.removeEventListener("click",i),classie.removeClass(s.el,"photostack-start"),t()):(s.openDefault=!0,setTimeout(t,25)),s.started=!0,s._showPhoto(s.current)};e?(this._shuffle(),this.el.addEventListener("click",i)):i(),this.navDots.forEach(function(t,e){t.addEventListener("click",function(){if(e===s.current)s._rotateItem();else{var t=function(){s._showPhoto(e)};s.flipped?s._rotateItem(t):t()}})}),r.addEventListener("resize",function(){s._resizeHandler()})},t.prototype._resizeHandler=function(){var t=this;this._resizeTimeout&&clearTimeout(this._resizeTimeout),this._resizeTimeout=setTimeout(function(){t._resize(),t._resizeTimeout=null},100)},t.prototype._resize=function(){var t=this,e=function(){t._shuffle(!0)};this._getSizes(),this.started&&this.flipped?this._rotateItem(e):e()},t.prototype._showPhoto=function(t){if(this.isShuffling)return!1;this.isShuffling=!0,classie.hasClass(this.currentItem,"photostack-flip")&&(this._removeItemPerspective(),classie.removeClass(this.navDots[this.current],"flippable")),classie.removeClass(this.navDots[this.current],"current"),classie.removeClass(this.currentItem,"photostack-current"),classie.addClass(this.currentItem,"photostack-inactive",5e3),this.current=t,this.currentItem=this.items[this.current],classie.addClass(this.navDots[this.current],"current"),this.currentItem.querySelector(".photostack-back")&&classie.addClass(this.navDots[t],"flippable"),this._shuffle()},t.prototype._shuffle=function(t){var m=t?1:this.currentItem.getAttribute("data-shuffle-iteration")||1;(m<=0||!this.started||this.openDefault)&&(m=1),this.openDefault&&(classie.addClass(this.currentItem,"photostack-flip"),this.openDefault=!1,this.isShuffling=!1);var u=.5,f=Math.ceil(this.sizes.inner.width/(this.sizes.item.width*u)),d=Math.ceil(this.sizes.inner.height/(this.sizes.item.height*u)),e=f*this.sizes.item.width*u+this.sizes.item.width/2-this.sizes.inner.width,s=d*this.sizes.item.height*u+this.sizes.item.height/2-this.sizes.inner.height,v=e/2,g=s/2,I=this,y=function(){--m;for(var a=[],t=0;t<d;++t)for(var e=a[t]=[],s=0;s<f;++s){var i=s*(I.sizes.item.width*u)-v,r=t*(I.sizes.item.height*u)-g,n=0,o=0;if(I.started&&0===m){var h=I._isOverlapping({x:i,y:r});if(h.overlapping)switch(n=h.noOverlap.x,o=h.noOverlap.y,Math.floor(3*Math.random())){case 0:n=0;break;case 1:o=0}}e[s]={x:i+n,y:r+o}}a=k(a);var c=0,l=0,p=0;I.allItems.forEach(function(t,e){c===f-1?(l=l===d-1?0:l+1,c=1):++c;Math.floor(Math.random()*f),Math.floor(Math.random()*d);var s=a[l][c-1],i=s.x,r=s.y,n=function(){++p,z&&this.removeEventListener(x,n),p===I.allItemsCount&&(0<m?y.call():(classie.addClass(I.currentItem,"photostack-flip"),I.isShuffling=!1,"function"==typeof I.options.callback&&I.options.callback(I.currentItem)))};I.items.indexOf(t)===I.current&&I.started&&0===m?(I.currentItem.style.WebkitTransform="translate("+I.centerItem.x+"px,"+I.centerItem.y+"px) rotate(0deg)",I.currentItem.style.msTransform="translate("+I.centerItem.x+"px,"+I.centerItem.y+"px) rotate(0deg)",I.currentItem.style.transform="translate("+I.centerItem.x+"px,"+I.centerItem.y+"px) rotate(0deg)",I.currentItem.querySelector(".photostack-back")&&I._addItemPerspective(),classie.addClass(I.currentItem,"photostack-current"),classie.removeClass(I.currentItem,"photostack-inactive")):(t.style.WebkitTransform="translate("+i+"px,"+r+"px) rotate("+Math.floor(71*Math.random()-35)+"deg)",t.style.msTransform="translate("+i+"px,"+r+"px) rotate("+Math.floor(71*Math.random()-35)+"deg)",t.style.transform="translate("+i+"px,"+r+"px) rotate("+Math.floor(71*Math.random()-35)+"deg)"),I.started&&(z?t.addEventListener(x,n):n())})};y.call()},t.prototype._getSizes=function(){this.sizes={inner:{width:this.inner.offsetWidth,height:this.inner.offsetHeight},item:{width:this.currentItem.offsetWidth,height:this.currentItem.offsetHeight}},this.centerItem={x:this.sizes.inner.width/2-this.sizes.item.width/2,y:this.sizes.inner.height/2-this.sizes.item.height/2}},t.prototype._isOverlapping=function(t){var e=this.sizes.item.width+this.sizes.item.width/5,s=this.sizes.item.height+this.sizes.item.height/5,i=this.sizes.inner.width/2-e/2,r=this.sizes.inner.height/2-s/2,n=this.sizes.item.width+100,a=this.sizes.item.height+100;if(t.x+n<i||t.x>i+e||t.y+a<r||t.y>r+s)return{overlapping:!1};var o=Math.random()<.5,h=Math.floor(Math.random()*(n/4+1)),c=Math.floor(Math.random()*(a/4+1));return{overlapping:!0,noOverlap:{x:o?-1*(t.x-i+n)-h:i+e-(t.x+n)+n+h,y:o?-1*(t.y-r+a)-c:r+s-(t.y+a)+a+c}}},t.prototype._addItemPerspective=function(){classie.addClass(this.el,"photostack-perspective")},t.prototype._removeItemPerspective=function(){classie.removeClass(this.el,"photostack-perspective"),classie.removeClass(this.currentItem,"photostack-flip")},t.prototype._rotateItem=function(t){if(classie.hasClass(this.el,"photostack-perspective")&&!this.isRotating&&!this.isShuffling){this.isRotating=!0;var e=this,s=function(){z&&i&&this.removeEventListener(x,s),e.isRotating=!1,"function"==typeof t&&t()};this.flipped?(classie.removeClass(this.navDots[this.current],"flip"),i?(this.currentItem.style.WebkitTransform="translate("+this.centerItem.x+"px,"+this.centerItem.y+"px) rotateY(0deg)",this.currentItem.style.transform="translate("+this.centerItem.x+"px,"+this.centerItem.y+"px) rotateY(0deg)"):classie.removeClass(this.currentItem,"photostack-showback")):(classie.addClass(this.navDots[this.current],"flip"),i?(this.currentItem.style.WebkitTransform="translate("+this.centerItem.x+"px,"+this.centerItem.y+"px) translate("+this.sizes.item.width+"px) rotateY(-179.9deg)",this.currentItem.style.transform="translate("+this.centerItem.x+"px,"+this.centerItem.y+"px) translate("+this.sizes.item.width+"px) rotateY(-179.9deg)"):classie.addClass(this.currentItem,"photostack-showback")),this.flipped=!this.flipped,z&&i?this.currentItem.addEventListener(x,s):s()}},r.Photostack=t}(window);